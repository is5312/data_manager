# Database Schema Documentation

## Overview

The data manager backend uses a **dual-layer architecture** with two types of database schemas:

1. **Metadata Tables** - Managed by Spring Data JPA, store logical table/column information
2. **Physical Tables** - Managed dynamically by JOOQ, store actual user data
3. **Spring Batch Tables** - Managed by Spring Batch for job execution tracking

All tables are stored in the **PostgreSQL `public` schema** (as configured in `application.yml`).

---

## 1. Metadata Tables (JPA-Managed)

These tables are defined via Flyway migrations and managed by Spring Data JPA repositories. They use a **logical naming** system where user-friendly labels are mapped to physical identifiers.

### 1.1 `base_reference_table`

**Purpose**: Stores metadata about logical tables (user-facing table definitions)

**Location**: 
- Migration: `db/migration/V1__init_meta_tables.sql`
- Entity: `com.datamanager.backend.entity.BaseReferenceTable`
- Repository: `com.datamanager.backend.repository.BaseReferenceTableRepository`

**Schema**:
```sql
CREATE TABLE base_reference_table (
    id SERIAL PRIMARY KEY,                           -- Auto-incrementing ID
    tbl_label VARCHAR(255) NOT NULL,                 -- User-friendly label (e.g., "Customers")
    tbl_link VARCHAR(255) NOT NULL UNIQUE,           -- Physical table name (e.g., "tbl_01arz3ndektsv4rrffq69g5fav")
    description TEXT,                                 -- Optional description (added in V4)
    version_no INTEGER DEFAULT 1,                     -- Version tracking (added in V4)
    add_ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP,       -- Creation timestamp
    add_usr VARCHAR(255),                             -- Creation user
    upd_ts TIMESTAMP,                                 -- Last update timestamp
    upd_usr VARCHAR(255)                              -- Last update user
);
```

**Key Fields**:
- `tbl_label`: Logical name shown to users (e.g., "Customers", "Orders")
- `tbl_link`: Physical table name in database (format: `tbl_{ULID}`)
- `version_no`: Increments on each update (via `@PreUpdate` hook in entity)

**Relationships**:
- One-to-many with `base_column_map` (via `id` -> `tbl_id`)

**Used In**:
- `TableMetadataService` - CRUD operations for tables
- `TableController` - REST API endpoints for table management

---

### 1.2 `base_column_map`

**Purpose**: Stores metadata about logical columns within tables

**Location**:
- Migration: `db/migration/V1__init_meta_tables.sql`
- Entity: `com.datamanager.backend.entity.BaseColumnMap`
- Repository: `com.datamanager.backend.repository.BaseColumnMapRepository`

**Schema**:
```sql
CREATE TABLE base_column_map (
    id SERIAL PRIMARY KEY,                           -- Auto-incrementing ID
    tbl_id INTEGER REFERENCES base_reference_table(id), -- Foreign key to table
    tbl_link VARCHAR(255) NOT NULL,                  -- Physical table name (denormalized for performance)
    col_label VARCHAR(255) NOT NULL,                 -- User-friendly column label (e.g., "Customer Name")
    col_link VARCHAR(255) NOT NULL,                  -- Physical column name (e.g., "col_01arz3ndektsv4rrffq69g5fav")
    description TEXT,                                 -- Optional description (added in V4)
    version_no INTEGER DEFAULT 1,                     -- Version tracking (added in V4)
    add_ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP,       -- Creation timestamp
    add_usr VARCHAR(255),                             -- Creation user
    upd_ts TIMESTAMP,                                 -- Last update timestamp
    upd_usr VARCHAR(255)                              -- Last update user
);
```

**Key Fields**:
- `col_label`: Logical column name shown to users (e.g., "Customer Name", "Order Date")
- `col_link`: Physical column name in database (format: `col_{ULID}`)
- `tbl_link`: Denormalized physical table name (for faster queries without joins)

**Relationships**:
- Many-to-one with `base_reference_table` (via `tbl_id`)

**Used In**:
- `TableMetadataService` - Column CRUD operations
- `ColumnController` - REST API endpoints for column management

---

## 2. Physical Tables (JOOQ-Managed)

These tables are created **dynamically at runtime** using JOOQ and store actual user data. Each physical table corresponds to one logical table defined in `base_reference_table`.

### 2.1 Naming Convention

**Table Names**: `tbl_{ULID}`
- Format: `tbl_` prefix + lowercase ULID (e.g., `tbl_01arz3ndektsv4rrffq69g5fav`)
- Generated by: `IdGenerator.generatePhysicalTableName()`
- ULID ensures uniqueness and chronological ordering

**Column Names**: `col_{ULID}`
- Format: `col_` prefix + lowercase ULID (e.g., `col_01bz3ndektsv4rrffq69g5fbv`)
- Generated by: `IdGenerator.generatePhysicalColumnName()` (in `TableMetadataServiceImpl`)

### 2.2 Standard Table Structure

Every physical table is created with these **standard audit columns**:

```sql
CREATE TABLE tbl_{ULID} (
    id BIGINT PRIMARY KEY,                           -- Auto-incrementing primary key (BIGINT identity)
    add_usr VARCHAR(255) DEFAULT 'system',           -- Creation user
    add_ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP,      -- Creation timestamp
    upd_usr VARCHAR(255),                            -- Last update user (nullable)
    upd_ts TIMESTAMP,                                -- Last update timestamp (nullable)
    -- ... user-defined columns added dynamically ...
);
```

**Creation Location**: `SchemaDaoImpl.createTable()`

### 2.3 User-Defined Columns

Additional columns are added dynamically using JOOQ based on user input. Supported types include:

- `VARCHAR(n)` / `TEXT` - String data
- `INTEGER` / `BIGINT` - Integer data
- `DECIMAL` / `NUMERIC` - Decimal numbers
- `BOOLEAN` - Boolean values
- `DATE` - Date values
- `TIMESTAMP` - Timestamp values
- `DOUBLE` / `REAL` - Floating point numbers

**Column Type Mapping**: Handled by `SchemaDaoImpl.parseColumnType()` and `normalizeInformationSchemaType()`

### 2.4 Example Physical Table

For a logical table "Customers" with columns "Name" and "Email", the physical table might look like:

```sql
CREATE TABLE tbl_01arz3ndektsv4rrffq69g5fav (
    id BIGINT PRIMARY KEY,
    add_usr VARCHAR(255) DEFAULT 'system',
    add_ts TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    upd_usr VARCHAR(255),
    upd_ts TIMESTAMP,
    col_01bz3ndektsv4rrffq69g5fbv VARCHAR(255),  -- "Name" column
    col_01cz3ndektsv4rrffq69g5fcv VARCHAR(255)   -- "Email" column
);
```

### 2.5 Management

**Creation**: `SchemaDaoImpl.createTable()` - Creates table with standard audit columns
**Column Addition**: `SchemaDaoImpl.addColumn()` - Adds user-defined columns
**Column Removal**: `SchemaDaoImpl.removeColumn()` - Removes columns
**Column Type Change**: `SchemaDaoImpl.alterColumnType()` - Changes column type
**Table Rename**: `SchemaDaoImpl.renameTable()` - Renames physical table
**Table Drop**: `SchemaDaoImpl.dropTable()` - Drops physical table
**Column Info**: `SchemaDaoImpl.getColumnTypes()` - Queries `information_schema.columns`

**Used In**:
- `TableMetadataServiceImpl` - Table/column CRUD operations
- `DataDaoImpl` - Data operations (INSERT, UPDATE, DELETE, SELECT)
- `DataController` - REST API endpoints for data operations

---

## 3. Spring Batch Tables

Spring Batch automatically creates metadata tables for job execution tracking when `spring.batch.jdbc.initialize-schema: always` is set.

**Configuration**: `application.yml` (line 52)

**Tables Created** (by Spring Batch framework):
- `BATCH_JOB_INSTANCE`
- `BATCH_JOB_EXECUTION`
- `BATCH_JOB_EXECUTION_PARAMS`
- `BATCH_STEP_EXECUTION`
- `BATCH_STEP_EXECUTION_CONTEXT`
- `BATCH_JOB_EXECUTION_CONTEXT`

**Purpose**: Track batch job executions, steps, and execution contexts for CSV import jobs

**Used In**:
- `CsvBatchUploadService` - CSV batch upload processing
- `BatchController` - Batch status tracking endpoints

---

## 4. Schema Evolution

### 4.1 Flyway Migrations

All metadata schema changes are managed via Flyway migrations in `db/migration/`:

1. **V1__init_meta_tables.sql** - Initial schema creation
   - Creates `base_reference_table` and `base_column_map`

2. **V2__seed_data.sql** - Seed data for development
   - Creates sample physical tables and metadata

3. **V3__fix_id_types.sql** - Type fixes
   - (Migration content not shown, but referenced)

4. **V4__add_description_and_version.sql** - Feature additions
   - Adds `description` and `version_no` columns to both metadata tables

### 4.2 Physical Schema Changes

Physical table schemas are managed dynamically:
- Column additions/removals update both:
  1. Physical table structure (via JOOQ)
  2. `base_column_map` metadata (via JPA)

- Table renames update:
  1. Physical table name (via JOOQ)
  2. `base_reference_table.tbl_link` (via JPA)

---

## 5. Database Configuration

**Database**: PostgreSQL
**Schema**: `public` (default)
**Connection**: Configured in `application.yml`
```yaml
spring:
  datasource:
    url: jdbc:postgresql://localhost:5432/datamanager?reWriteBatchedInserts=true
    username: postgres
    password: changeme
  flyway:
    schemas: public
```

**JPA Configuration**:
- `ddl-auto: validate` - Flyway manages schema, JPA validates
- Dialect: `PostgreSQLDialect`

**JOOQ Configuration**:
- SQL Dialect: `POSTGRES`

---

## 6. Key Design Patterns

### 6.1 Logical vs Physical Separation

- **Logical Names**: User-facing friendly names (`tbl_label`, `col_label`)
- **Physical Names**: Database identifiers (`tbl_link`, `col_link`)
- **Benefits**: 
  - Users can rename tables/columns without affecting physical structure
  - Prevents SQL injection through friendly names
  - Allows table/column name changes without data migration

### 6.2 Dual ORM Strategy

- **JPA/Hibernate**: For metadata tables (structured, known schema)
- **JOOQ**: For physical tables (dynamic, runtime-created schema)
- **Benefits**:
  - Type-safe queries for metadata
  - Dynamic DDL/DML for user data
  - Best of both worlds

### 6.3 Audit Trail

All tables include standard audit columns:
- `add_usr` / `add_ts` - Creation tracking
- `upd_usr` / `upd_ts` - Update tracking
- Managed automatically via JPA `@PrePersist` / `@PreUpdate` hooks

---

## 7. Schema Locations Summary

| Schema Type | Definition | Management | Query Method |
|------------|------------|------------|--------------|
| Metadata Tables | Flyway migrations | JPA Repositories | Spring Data JPA |
| Physical Tables | Runtime (JOOQ) | SchemaDao (JOOQ) | DataDao (JOOQ) |
| Batch Tables | Spring Batch auto-creation | Spring Batch | JobExplorer API |

---

## 8. Related Files

### Entity Definitions
- `src/main/java/com/datamanager/backend/entity/BaseReferenceTable.java`
- `src/main/java/com/datamanager/backend/entity/BaseColumnMap.java`

### DAO Implementations
- `src/main/java/com/datamanager/backend/dao/impl/SchemaDaoImpl.java` - Physical table DDL
- `src/main/java/com/datamanager/backend/dao/impl/DataDaoImpl.java` - Physical table DML

### Service Layer
- `src/main/java/com/datamanager/backend/service/impl/TableMetadataServiceImpl.java` - Metadata operations

### Utilities
- `src/main/java/com/datamanager/backend/util/IdGenerator.java` - ULID generation for physical names

### Migrations
- `src/main/resources/db/migration/V1__init_meta_tables.sql`
- `src/main/resources/db/migration/V4__add_description_and_version.sql`

