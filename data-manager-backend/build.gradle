plugins {
    id 'java'
    id 'org.springframework.boot'
    id 'io.spring.dependency-management'
    id 'com.google.protobuf' version '0.9.4'
}

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
    }
}

springBoot {
    mainClass = 'com.datamanager.backend.BackendApplication'
}

dependencies {
    implementation project(':data-manager-client')
    
    // Spring Boot starters
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-actuator'
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-jdbc'
    implementation 'org.springframework.boot:spring-boot-starter-jooq'
    implementation 'org.springframework.boot:spring-boot-starter-batch'
    
    // Database
    runtimeOnly 'org.postgresql:postgresql'
    implementation 'org.postgresql:postgresql'
    
    // Flyway for migrations
    implementation 'org.flywaydb:flyway-core'
    implementation 'com.github.f4b6a3:ulid-creator:5.2.3'
    implementation 'org.flywaydb:flyway-database-postgresql'

    // CSV parsing (robust handling of quotes, commas, newlines)
    implementation 'org.apache.commons:commons-csv:1.11.0'
    implementation 'com.opencsv:opencsv:5.9'
    implementation 'commons-io:commons-io:2.15.1'
    
    // Apache Arrow for efficient binary data streaming
    implementation platform('org.apache.arrow:arrow-bom:15.0.0')
    implementation 'org.apache.arrow:arrow-vector'
    implementation 'org.apache.arrow:arrow-memory-netty'
    implementation 'org.apache.arrow:arrow-jdbc'
    
    // JobRunr for async job processing
    implementation 'org.jobrunr:jobrunr-spring-boot-3-starter:8.4.0'
    
    // gRPC and Protobuf
    implementation 'net.devh:grpc-server-spring-boot-starter:3.1.0.RELEASE'
    implementation 'io.grpc:grpc-protobuf:1.60.0'
    implementation 'io.grpc:grpc-stub:1.60.0'
    implementation 'com.google.protobuf:protobuf-java:3.25.1'
    compileOnly 'javax.annotation:javax.annotation-api:1.3.2'
    
    // Lombok for reducing boilerplate
    compileOnly 'org.projectlombok:lombok'
    annotationProcessor 'org.projectlombok:lombok'
    
    // Testing
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
    
    // gRPC testing
    testImplementation 'io.grpc:grpc-testing:1.60.0'
    testImplementation 'io.grpc:grpc-inprocess:1.60.0'
    
    // Embedded PostgreSQL for integration tests (no Docker required)
    testImplementation 'io.zonky.test:embedded-postgres:2.0.3'
    testImplementation 'io.zonky.test:embedded-database-spring-test:2.5.0'
    
    // AssertJ for fluent assertions
    testImplementation 'org.assertj:assertj-core'
}

tasks.named('bootRun') {
    jvmArgs = [
        '--add-opens=java.base/java.nio=ALL-UNNAMED',
        '--add-opens=java.base/java.lang=ALL-UNNAMED',
        '--add-opens=java.base/java.util=ALL-UNNAMED',
        '-Darrow.memory.debug.allocator=false', 
        '-Darrow.enable_unsafe_memory_access=true'
    ]
}

tasks.named('test') {
    useJUnitPlatform()
}

// Protobuf configuration
protobuf {
    protoc {
        artifact = 'com.google.protobuf:protoc:3.25.1'
    }
    plugins {
        grpc {
            artifact = 'io.grpc:protoc-gen-grpc-java:1.60.0'
        }
    }
    generateProtoTasks {
        all()*.plugins {
            grpc {}
        }
    }
}

sourceSets {
    main {
        java {
            srcDirs 'build/generated/source/proto/main/grpc'
            srcDirs 'build/generated/source/proto/main/java'
        }
    }
}
