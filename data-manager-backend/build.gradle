plugins {
    id 'java'
    id 'org.springframework.boot'
    id 'io.spring.dependency-management'
}

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
    }
}

springBoot {
    mainClass = 'com.datamanager.backend.BackendApplication'
}

dependencies {
    implementation project(':data-manager-client')
    
    // Spring Boot starters
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-jdbc'
    implementation 'org.springframework.boot:spring-boot-starter-jooq'
    implementation 'org.springframework.boot:spring-boot-starter-batch'
    
    // Database
    runtimeOnly 'org.postgresql:postgresql'
    implementation 'org.postgresql:postgresql'
    
    // Flyway for migrations
    implementation 'org.flywaydb:flyway-core'
    implementation 'com.github.f4b6a3:ulid-creator:5.2.3'
    implementation 'org.flywaydb:flyway-database-postgresql'

    // CSV parsing (robust handling of quotes, commas, newlines)
    implementation 'org.apache.commons:commons-csv:1.11.0'
    implementation 'com.opencsv:opencsv:5.9'
    implementation 'commons-io:commons-io:2.15.1'
    
    // Apache Arrow for efficient binary data streaming
    implementation platform('org.apache.arrow:arrow-bom:15.0.0')
    implementation 'org.apache.arrow:arrow-vector'
    implementation 'org.apache.arrow:arrow-memory-netty'
    implementation 'org.apache.arrow:arrow-jdbc'
    
    // Lombok for reducing boilerplate
    compileOnly 'org.projectlombok:lombok'
    annotationProcessor 'org.projectlombok:lombok'
    
    // Testing
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
}

tasks.named('bootRun') {
    jvmArgs = [
        '--add-opens=java.base/java.nio=ALL-UNNAMED',
        '--add-opens=java.base/java.lang=ALL-UNNAMED',
        '--add-opens=java.base/java.util=ALL-UNNAMED',
        '-Darrow.memory.debug.allocator=false', 
        '-Darrow.enable_unsafe_memory_access=true'
    ]
}
